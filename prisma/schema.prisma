generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(cuid())
  githubId      String         @unique
  email         String         @unique
  name          String?
  apiKey        String?        @unique
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  installations Installation[]
}

model Installation {
  id              String             @id @default(cuid())
  githubInstallId String             @unique
  owner           String
  repo            String
  userId          String
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  reports         ComplianceReport[]
  user            User               @relation(fields: [userId], references: [id])
}

model ComplianceReport {
  id             String       @id @default(cuid())
  status         String
  summary        Json
  issues         Json
  installationId String
  createdAt      DateTime     @default(now())
  installation   Installation @relation(fields: [installationId], references: [id])
}

model CheckRun {
  id            String   @id @default(cuid())
  repositoryId  String
  owner         String
  repo          String
  branchName    String   @default("main") // Branch that was checked
  status        String   // 'PENDING' | 'IN_PROGRESS' | 'COMPLETED' | 'FAILED'
  checkType     String   // 'APPLE_APP_STORE' | 'GOOGLE_PLAY_STORE' | 'CHROME_WEB_STORE' | 'MOBILE_PLATFORMS'
  issues        Json?    // Array of ComplianceIssue
  files         Json?    // Cached repository files {[filename]: content}
  errorType     String?  // ComplianceErrorType enum value
  errorMessage  String?  // User-friendly error message
  errorDetails  String?  // JSON string with additional error context
  retryable     Boolean  @default(false)
  createdAt     DateTime @default(now())
  completedAt   DateTime?
  updatedAt     DateTime @updatedAt
  
  @@index([repositoryId])
  @@index([owner, repo])
  @@index([status])
  @@index([createdAt])
}

model DailyStats {
  id             String   @id @default(cuid())
  date           DateTime @unique // Midnight of the day
  totalChecks    Int      @default(0)
  passedChecks   Int      @default(0)
  failedChecks   Int      @default(0)
  totalIssues    Int      @default(0)
  highSeverity   Int      @default(0)
  mediumSeverity Int      @default(0)
  lowSeverity    Int      @default(0)
  averageScore   Float    @default(0) // 0-100 compliance score
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}
